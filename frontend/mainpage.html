<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ransomware Behavior Analytics</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f5f6fa;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background: #373737;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        button:disabled {
            background: #777;
        }
        .chart_results {
            display: flex;
            gap: 20px;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .chart_results .chart-container {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>

    <h1>Ransomware Behavior Analytics üîç</h1>

    <!-- sample ÏÑ†ÌÉù(ÎØºÍ≤Ω) - start -->
    <div class="card">
        <h1>Autoencoder Model ü§ñ</h1>
        <h2>Choose for samples of Ransomware Behavior Analytics</h2>
        ‚≠ï Multiple selection possible‚≠ï
        <div id="checkbox_container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">

        </div>
        <button id="trainBtn">Î™®Îç∏ ÌõàÎ†® ÏãúÏûë</button>

        <div id="progress_container" style="display:none; margin-top: 20px;">
            <div style="width: 100%; background-color: #e0e0e0; border-radius: 8px;">
                <div id="progress_bar" style="width: 0%; height: 24px; background-color: #4caf50; border-radius: 8px; transition: width 0.4s ease;"></div>
            </div>
            <p id="progress_text" style="text-align: center; margin-top: 5px; font-weight: bold; color: #555;">0%</p>
        </div>

        <p id="status"></p>
    </div>
    <!-- sample ÏÑ†ÌÉù (ÎØºÍ≤Ω) - end -->


    <!-- SampleÎì§Ïùò Threshold Í∑∏ÎûòÌîÑ ÌëúÏãúÌïòÍ∏∞(ÏäπÏö¥) -start -->


    <!-- SampleÎì§Ïùò Threshold Í∑∏ÎûòÌîÑ ÌëúÏãúÌïòÍ∏∞(ÏäπÏö¥) -end -->


    <!-- Autoencoder Í≤∞Í≥º -->
    <div id="ae_section" class="card" style="display:none;">
        <h2>Autoencoder Í≤∞Í≥º</h2>
        <div class="chart_results"><div class="chart-container">
            <canvas id="ae_loss"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="ae_acc"></canvas>
        </div>
        </div>
    </div>


    <!-- class Î∂ÑÎ•ò Í∑∏ÎûòÌîÑ ÌëúÏãúÌïòÍ∏∞(ÏäπÌù¨) -start  -->


    <!-- class Î∂ÑÎ•ò Í∑∏ÎûòÌîÑ ÌëúÏãúÌïòÍ∏∞(ÏäπÌù¨) -end  -->


    <!-- LSTM Í≤∞Í≥º -->
    <div id="lstm_section" class="card" style="display:none;">
        <h2>LSTM Î™®Îç∏ Í≤∞Í≥º</h2>

        <div class="chart_results"><div class="chart-container">
            <canvas id="lstm_loss"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="lstm_acc"></canvas>
        </div>
        </div>
    </div>


    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ===================================================
        // 1) ÏÑúÎ≤ÑÏóêÏÑú sample_id Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Î∞è Ï≤¥ÌÅ¨ Î∞ïÏä§ ÏÉùÏÑ±
        // ===================================================
        async function loadSamples() {
            try {
                const res = await fetch("/samples/");
                const data = await res.json();
                const container = document.getElementById("checkbox_container");

                if (data.sample_ids) {
                    data.sample_ids.forEach(id => {
                        const label = document.createElement("label");
                        label.style.display = "block";

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = id;
                        checkbox.name = "sample_id_checkbox";
                        checkbox.style.marginRight = "5px";

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(id));
                        container.appendChild(label);
                    });
                }
            } catch (e) {
                console.error("ÏÉòÌîå Î°úÎìú Ïã§Ìå®:", e);
            }
        }

        loadSamples();

        // ===================================================
        // 2) Î™®Îç∏ ÌõàÎ†® ÏöîÏ≤≠ (Ïä§Ìä∏Î¶¨Î∞ç Î∞©Ïãù Ï†ÅÏö©)
        // ===================================================
        document.getElementById("trainBtn").onclick = async () => {
            const checkboxes = document.querySelectorAll('#checkbox_container input[type="checkbox"]:checked');
            
            // ÏÑ†ÌÉùÍ∞í Ï∂îÏ∂ú
            const selectedValues = Array.from(checkboxes).map(cb => cb.value);

            if (selectedValues.length === 0) {
                alert("ÌõàÎ†®Ìï† ÏÉòÌîåÏùÑ ÌïòÎÇò Ïù¥ÏÉÅ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            // 1. UI Ï¥àÍ∏∞Ìôî (Î°úÎî©Î∞î ÌëúÏãú, Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî, Ïù¥Ï†Ñ Í∑∏ÎûòÌîÑ Ïà®ÍπÄ)
            const btn = document.getElementById("trainBtn");
            const statusText = document.getElementById("status");
            const progressContainer = document.getElementById("progress_container");
            const progressBar = document.getElementById("progress_bar");
            const progressPercent = document.getElementById("progress_text");

            btn.disabled = true;
            statusText.textContent = "ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï§ë...";
            progressContainer.style.display = "block"; // Î°úÎî©Î∞î Î≥¥Ïù¥Í∏∞
            progressBar.style.width = "0%";
            progressPercent.textContent = "0%";

            document.getElementById("ae_section").style.display = "none";
            document.getElementById("lstm_section").style.display = "none";

            try {
                // 2. Ïä§Ìä∏Î¶¨Î∞ç ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                const response = await fetch("/train/", { // urlÏùÄ views.py url ÏÑ§Ï†ïÏóê Îî∞Î¶Ñ (ex: /train_models/)
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sample_ids: selectedValues })
                });

                // Ïä§Ìä∏Î¶º Î¶¨Îçî ÏÉùÏÑ±
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                // 3. Îç∞Ïù¥ÌÑ∞ Ï°∞Í∞Å(Chunk) ÏùΩÍ∏∞ Î£®ÌîÑ
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    // Ï§ÑÎ∞îÍøàÏúºÎ°ú ÎÇòÎàÑÏñ¥ Ï≤òÎ¶¨ (Ìïú Î≤àÏóê Ïó¨Îü¨ Ï§ÑÏù¥ Ïò¨ Ïàò ÏûàÏùå)
                    const lines = chunk.split("\n").filter(line => line.trim() !== "");

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);

                            if (data.status === "progress") {
                                // [ÏßÑÌñâ Ï§ë] Î°úÎî©Î∞î ÏóÖÎç∞Ïù¥Ìä∏
                                progressBar.style.width = data.percent + "%";
                                progressPercent.textContent = data.percent + "%";
                                statusText.textContent = data.message;

                            } else if (data.status === "complete") {
                                // [ÏôÑÎ£å] Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞
                                progressBar.style.width = "100%";
                                progressPercent.textContent = "100%";
                                statusText.textContent = "ÌõàÎ†® ÏôÑÎ£å! Í≤∞Í≥º Î∂ÑÏÑù Ï§ë...";
                                
                                // Ïû†Ïãú ÌõÑ Í∑∏ÎûòÌîÑ ÌëúÏãú
                                setTimeout(() => {
                                    renderAutoencoderCharts(data.results.autoencoder);
                                    renderLstmCharts(data.results.lstm);
                                    statusText.textContent = "Î™®Îì† ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.";
                                    btn.disabled = false;
                                }, 500);

                            } else if (data.status === "error") {
                                // [ÏóêÎü¨]
                                statusText.textContent = "Ïò§Î•ò: " + data.message;
                                progressBar.style.backgroundColor = "red";
                                btn.disabled = false;
                            }
                        } catch (e) {
                            console.error("JSON ÌååÏã± ÏóêÎü¨:", e);
                        }
                    }
                }

            } catch (err) {
                statusText.textContent = "ÌÜµÏã† Ïò§Î•ò Î∞úÏÉù: " + err;
                btn.disabled = false;
            }
        };

        // ===================================================
        // 3) Í∑∏ÎûòÌîÑ Î†åÎçîÎßÅ Ìï®ÏàòÎì§ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
        // ===================================================
        let aeLossChart, aeAccChart, lstmLossChart, lstmAccChart;

        function renderAutoencoderCharts(ae) {
            document.getElementById("ae_section").style.display = "block";
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ ÏÇ≠Ï†ú (Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ)
            if (aeLossChart) aeLossChart.destroy();
            if (aeAccChart) aeAccChart.destroy();

            aeLossChart = new Chart(document.getElementById("ae_loss"), {
                type: "line",
                data: {
                    labels: ae.loss.map((_, i) => i + 1),
                    datasets: [
                        { label: "Loss", data: ae.loss, borderColor: "red", fill: false },
                        { label: "Val Loss", data: ae.val_loss || [], borderColor: "orange", fill: false }
                    ]
                }
            });

            aeAccChart = new Chart(document.getElementById("ae_acc"), {
                type: "line",
                data: {
                    labels: ae.accuracy.map((_, i) => i + 1),
                    datasets: [
                        { label: "Accuracy", data: ae.accuracy, borderColor: "blue", fill: false },
                        { label: "Val Accuracy", data: ae.val_accuracy || [], borderColor: "skyblue", fill: false }
                    ]
                }
            });
        }

        function renderLstmCharts(lstm) {
            document.getElementById("lstm_section").style.display = "block";

            if (lstmLossChart) lstmLossChart.destroy();
            if (lstmAccChart) lstmAccChart.destroy();

            lstmLossChart = new Chart(document.getElementById("lstm_loss"), {
                type: "line",
                data: {
                    labels: lstm.loss.map((_, i) => i + 1),
                    datasets: [
                        { label: "Loss", data: lstm.loss, borderColor: "red", fill: false },
                        { label: "Val Loss", data: lstm.val_loss || [], borderColor: "orange", fill: false }
                    ]
                }
            });

            lstmAccChart = new Chart(document.getElementById("lstm_acc"), {
                type: "line",
                data: {
                    labels: lstm.accuracy.map((_, i) => i + 1),
                    datasets: [
                        { label: "Accuracy", data: lstm.accuracy, borderColor: "blue", fill: false },
                        { label: "Val Accuracy", data: lstm.val_accuracy || [], borderColor: "skyblue", fill: false }
                    ]
                }
            });
        }
    </script>
</body>
</html>
