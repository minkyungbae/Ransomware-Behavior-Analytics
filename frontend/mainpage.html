<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ransomware Behavior Analytics</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f5f6fa;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background: #373737;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        button:disabled {
            background: #777;
        }
        select {
            padding: 8px;
            font-size: 16px;
            margin-right: 15px;
            height: 100px;
            vertical-align: top;
        }
        .chart-container {
            width: 700px;
            margin: 30px 0;
        }
    </style>
</head>
<body>

    <h1>Ransomware Behavior Analytics</h1>

    <!-- Class 선택 -->
    <div class="card">
        <h1>Autoencoder Model</h1>
        <h2>1. 분석할 Class 선택(여러 개 선택 가능)</h2>
        <select id="class_select" multiple></select>
        <button id="trainBtn">모델 훈련 시작</button>
        <p id="status"></p>
    </div>

    <!-- Autoencoder 결과 -->
    <div id="ae_section" class="card" style="display:none;">
        <h2>Autoencoder 결과</h2>

        <div class="chart-container">
            <canvas id="ae_loss"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="ae_acc"></canvas>
        </div>
    </div>

    <!-- LSTM 결과 -->
    <div id="lstm_section" class="card" style="display:none;">
        <h2>LSTM 모델 결과</h2>

        <div class="chart-container">
            <canvas id="lstm_loss"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="lstm_acc"></canvas>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ===================================================
        // 1) 서버에서 class_id 목록 가져오기
        // ===================================================
        async function loadClasses() {
            const res = await fetch("/classes/");
            const data = await res.json();

            const select = document.getElementById("class_select");

            data.class_ids.forEach(id => {
                const opt = document.createElement("option");
                opt.value = id;
                opt.textContent = "Class " + id;
                select.appendChild(opt);
            });
        }

        loadClasses();

        // ===================================================
        // 2) 모델 훈련 요청
        // ===================================================
        document.getElementById("trainBtn").onclick = async () => {

            const select = document.getElementById("class_select");
            const status = document.getElementById("status");

            const selectedValues = Array.from(select.selectedOptions).map(option => Number(option.value));
            if (selectedValues.length === 0) {
                alert("최소 하나의 Class를 선택해주세요.")
                return;
            }
            
            
            status.textContent = "모델 훈련 중... 잠시만 기다려주세요.";
            document.getElementById("trainBtn").disabled = true;

            const response = await fetch("/train/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ class_ids: selecetedValues })
            });

            const data = await response.json();
            document.getElementById("trainBtn").disabled = false;

            if (data.error) {
                status.textContent = "오류 발생: " + data.error;
                return;
            }

            status.textContent = "훈련 완료! 아래 그래프를 확인하세요.";

            // 그래프 표시
            renderAutoencoderCharts(data.results.autoencoder);
            renderLstmCharts(data.results.lstm);
        };


        // ===================================================
        // 3) Autoencoder 그래프
        // ===================================================
        function renderAutoencoderCharts(ae) {
            document.getElementById("ae_section").style.display = "block";

            new Chart(document.getElementById("ae_loss"), {
                type: "line",
                data: {
                    labels: ae.loss.map((_, i) => i + 1),
                    datasets: [
                        { label: "Loss", data: ae.loss, borderWidth: 2 },
                        { label: "Val Loss", data: ae.val_loss, borderWidth: 2 }
                    ]
                }
            });

            new Chart(document.getElementById("ae_acc"), {
                type: "line",
                data: {
                    labels: ae.accuracy.map((_, i) => i + 1),
                    datasets: [
                        { label: "Accuracy", data: ae.accuracy, borderWidth: 2 },
                        { label: "Val Accuracy", data: ae.val_accuracy, borderWidth: 2 }
                    ]
                }
            });
        }


        // ===================================================
        // 4) LSTM 그래프
        // ===================================================
        function renderLstmCharts(lstm) {
            document.getElementById("lstm_section").style.display = "block";

            new Chart(document.getElementById("lstm_loss"), {
                type: "line",
                data: {
                    labels: lstm.loss.map((_, i) => i + 1),
                    datasets: [
                        { label: "Loss", data: lstm.loss, borderWidth: 2 },
                        { label: "Val Loss", data: lstm.val_loss, borderWidth: 2 }
                    ]
                }
            });

            new Chart(document.getElementById("lstm_acc"), {
                type: "line",
                data: {
                    labels: lstm.accuracy.map((_, i) => i + 1),
                    datasets: [
                        { label: "Accuracy", data: lstm.accuracy, borderWidth: 2 },
                        { label: "Val Accuracy", data: lstm.val_accuracy, borderWidth: 2 }
                    ]
                }
            });
        }

    </script>
</body>
</html>
